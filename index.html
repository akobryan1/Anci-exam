<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Animal Science Final Exam</title>
  <style>
    :root{
      --bg:#0f172a;
      --card:#111827;
      --border:#1f2937;
      --muted:#9ca3af;
      --text:#e5e7eb;
      --accent:#22c55e;
      --danger:#f97373;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
      background:radial-gradient(circle at top,#1e293b,#020617);
      color:var(--text);
    }
    .wrap{
      max-width:960px;
      margin:0 auto;
      padding:24px;
    }
    .card{
      background:linear-gradient(180deg,#020617,#020617 10%,#020617 70%,#020617);
      border:1px solid var(--border);
      border-radius:16px;
      padding:20px;
      box-shadow:0 18px 40px rgba(0,0,0,0.55);
    }
    h1,h2{
      margin:0 0 10px 0;
      color:#e2e8f0;
    }
    ul{padding-left:20px;}
    .small{font-size:13px;color:var(--muted);}
    .pill{
      padding:6px 10px;
      border-radius:999px;
      background:#020617;
      border:1px solid var(--border);
      font-size:12px;
      margin-right:6px;
      display:inline-block;
      color:#cbd5e1;
    }
    .meta-row{
      margin-bottom:10px;
    }
    .field{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin:10px 0;
    }
    input[type="text"]{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #334155;
      background:#020617;
      color:#e5e7eb;
      flex:1;
      min-width:220px;
    }
    button{
      padding:10px 16px;
      border-radius:12px;
      border:1px solid #263042;
      background:#020617;
      color:#e5e7eb;
      cursor:pointer;
      transition:background .15s,transform .1s;
    }
    button.primary{
      background:linear-gradient(135deg,#16a34a,#22c55e);
      border-color:#15803d;
      color:#022c22;
      font-weight:600;
    }
    button:disabled{
      opacity:.6;
      cursor:not-allowed;
    }
    button:hover:not(:disabled){
      filter:brightness(1.05);
      transform:translateY(-1px);
    }
    .progress{
      height:8px;
      background:#020617;
      border-radius:999px;
      margin-bottom:12px;
      border:1px solid #1f2937;
      overflow:hidden;
    }
    .bar{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,#22c55e,#4ade80);
      transition:width .2s ease-out;
    }
    #choices{
      display:flex;
      flex-direction:column;
      gap:12px;
      width:100%;
    }
    .choice{
      display:flex;
      flex-direction:row;
      align-items:flex-start;
      width:100%;
      max-width:100% !important;
      background:#020617;
      border:1px solid #1f2937;
      border-radius:10px;
      padding:12px;
      box-sizing:border-box;
    }
    .choice input{
      margin-top:4px;
      flex-shrink:0;
    }
    .choice div{
      flex:1;
      white-space:normal !important;
      overflow-wrap:break-word !important;
      word-break:break-word !important;
      color:#e5e7eb;
    }
    .choice b{
      display:inline-block;
      width:22px;
    }
    .footer{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top:20px;
      flex-wrap:wrap;
    }
    .hidden{display:none;}
    .error{
      color:#fecaca;
      font-size:13px;
      margin-top:6px;
    }
    @media (max-width:600px){
      .footer{flex-direction:column;align-items:stretch;}
      button{width:100%;}
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>Animal Science Final Exam</h1>

    <div id="meta" class="meta-row hidden">
      <span class="pill" id="pillName">Name: —</span>
      <span class="pill" id="pillSection">Year/Section: —</span>
      <span class="pill" id="pillTimer">Time: 60:00</span>
      <span class="pill" id="pillCount">Q: — / —</span>
      <span class="pill" id="pillAttempts">Attempts used: 0 / 2</span>
    </div>

    <!-- Stage 0: Instructions -->
    <section id="stage0">
      <h2>Exam Instructions</h2>
      <ul>
        <li>This exam is <strong>screen recorded</strong>.</li>
        <li>You have <strong>1 hour</strong> to finish once you start.</li>
        <li>You may take the exam <strong>twice</strong>. After the second take, all attempts will be blocked.</li>
        <li>The link will be closed at <strong>11:59:59 PM on 20 November 2025</strong>.</li>
      </ul>
      <p class="small">
        Make sure you have a stable internet connection. Do not close this tab while taking the exam.
      </p>
      <div class="error" id="errStage0" style="display:none;"></div>
      <button class="primary" id="btnUnderstand">I understand</button>
    </section>

    <!-- Stage 1: Student Info -->
    <section id="stage1" class="hidden">
      <h2>Student Information</h2>
      <div class="field">
        <input type="text" id="inpName" placeholder="Full Name"/>
        <input type="text" id="inpSection" placeholder="Year & Section"/>
      </div>
      <div class="error" id="errStage1" style="display:none;"></div>
      <div class="footer">
        <button id="btnBack">Back</button>
        <button class="primary" id="btnStart">Next</button>
      </div>
    </section>

    <!-- Stage 2: Questions -->
    <section id="stage2" class="hidden">
      <div class="progress"><div id="bar" class="bar"></div></div>
      <p id="qtext"></p>
      <div id="choices"></div>
      <div class="error" id="errStage2" style="display:none;"></div>
      <div class="footer">
        <button id="btnPrev">Review</button>
        <div>
          <button id="btnNext" class="primary">Next</button>
          <button id="btnSubmit" class="primary hidden">Submit</button>
        </div>
      </div>
    </section>

    <!-- Stage 3: Result -->
    <section id="stage3" class="hidden">
      <h2>Submission Complete</h2>
      <p><strong id="rName"></strong> (<span id="rSection"></span>)</p>
      <p>Your Score: <strong id="rScore"></strong></p>
      <p class="small">
        Your answers have been saved to the database. You may retake the exam only if you still have remaining attempts.
      </p>
      <p class="error" id="rNote" style="display:none;"></p>
    </section>

  </div>
</div>

<script type="module">
/* =============================
   ANSCI QUESTION BANK (1–50)
   ============================= */

const QUESTIONS = [
  {num:1, q:"A gene is best defined as:", A:"A nutrient in the diet", B:"A unit of heredity that controls traits", C:"A type of hormone", D:"A body organ", ans:"B"},
  {num:2, q:"Genes influence animal productivity by:", A:"Deciding what feeds animals prefer", B:"Controlling inherited traits such as growth, milk, and egg production", C:"Eliminating all environmental effects", D:"Creating diseases", ans:"B"},
  {num:3, q:"A breeder selects animals with high milk yield to produce the next generation. This is an example of:", A:"Nutritional management", B:"Environmental selection", C:"Genetic selection based on desirable traits", D:"Random mating", ans:"C"},
  {num:4, q:"Records show that two cows have similar environments but different milk yields. What is the most logical analysis?", A:"Milk yield is unrelated to genetics", B:"Genetic differences likely account for the variation", C:"Environment controls 100% of traits", D:"Nutrition plays no role", ans:"B"},
  {num:5, q:"A breeder must choose between a cow with high milk potential but low fertility and another with moderate milk but excellent fertility. From a breeding standpoint, how should this be evaluated?", A:"Choose only the high milk cow", B:"Consider overall productivity, fertility, and herd goals before selecting", C:"Fertility does not matter", D:"Traits should never be compared", ans:"B"},
  {num:6, q:"Reproductive traits such as fertility and litter size are considered:", A:"Production traits", B:"Functional traits", C:"Aesthetic traits", D:"Irrelevant traits", ans:"B"},
  {num:7, q:"Growth rate, carcass quality, and egg production are examples of:", A:"Behavioral traits", B:"Production traits", C:"Non-genetic traits", D:"Diseases", ans:"B"},
  {num:8, q:"A poultry farmer selects hens that lay earlier and more frequently. What trait is being selected?", A:"Behavioral", B:"Egg production", C:"Structural", D:"Aesthetic", ans:"B"},
  {num:9, q:"A study shows that pigs with slower growth have lower feed efficiency. What does this imply?", A:"Growth and feed efficiency may be genetically related", B:"Growth has no effect on feed use", C:"Feed efficiency is random", D:"Slow growth is beneficial", ans:"A"},
  {num:10, q:"A farmer prioritizes calm temperament in cattle to reduce accidents. How should this decision be evaluated?", A:"Unimportant to breeding", B:"Positive, because behavior affects handling and productivity", C:"Negative, because temperament is not heritable", D:"Only color should be selected", ans:"B"},

  {num:11, q:"A dominant gene is expressed when:", A:"Only the recessive allele is present", B:"Only in females", C:"Present in one or both alleles", D:"The environment is perfect", ans:"C"},
  {num:12, q:"Recessive traits appear only when:", A:"The dominant allele is present", B:"The recessive allele is masked", C:"An individual has two recessive alleles", D:"Animals are unhealthy", ans:"C"},
  {num:13, q:"Crossing a pure red bull with a pure white cow produces all roan calves. This demonstrates:", A:"Complete dominance", B:"Incomplete dominance", C:"Mutation", D:"Codominance", ans:"D"},
  {num:14, q:"If two heterozygous parents mate, the expected ratio of dominant to recessive offspring is:", A:"1:1", B:"3:1", C:"1:3", D:"2:2", ans:"B"},
  {num:15, q:"A breeder insists that environment alone determines traits. How should this be evaluated genetically?", A:"Correct", B:"Incorrect, because both genes and environment affect traits", C:"Genes are irrelevant", D:"Only nutrition matters", ans:"B"},

  {num:16, q:"A gene pool refers to:", A:"A water source for animals", B:"The total genetic material in a population", C:"The feed bucket", D:"All animals in a farm", ans:"B"},
  {num:17, q:"Population genetics is the study of:", A:"Nutrition only", B:"How gene frequencies change in groups of animals", C:"Marketing animals", D:"Slaughtering procedures", ans:"B"},
  {num:18, q:"A farmer introduces unrelated males into the herd to increase variation. This is:", A:"Inbreeding", B:"Genetic drift", C:"Outcrossing", D:"Selection", ans:"C"},
  {num:19, q:"A population shows reduced fertility and growth due to high inbreeding. What does this indicate?", A:"Inbreeding depression", B:"Hybrid vigor", C:"No genetic effect", D:"Sudden mutation", ans:"A"},
  {num:20, q:"Which strategy should be prioritized for long-term herd improvement?", A:"Random mating", B:"Balanced selection for multiple traits", C:"Focusing on one trait only", D:"Avoiding performance records", ans:"B"},

  {num:21, q:"Artificial insemination (AI) is:", A:"Natural mating", B:"Direct insertion of semen into the reproductive tract", C:"Embryo destruction", D:"Castration", ans:"B"},
  {num:22, q:"MOET increases productivity by:", A:"Producing more offspring from superior females", B:"Reducing embryo numbers", C:"Preventing ovulation", D:"Increasing feeding cost", ans:"A"},
  {num:23, q:"A farmer uses pure breeding to maintain desirable traits in pigs. This is an example of:", A:"Random mating", B:"Outbreeding", C:"Inbreeding or linebreeding", D:"Crossbreeding", ans:"C"},
  {num:24, q:"Crossbreeding commonly results in:", A:"Inbreeding depression", B:"Hybrid vigor or heterosis", C:"Reduced performance", D:"Lower fertility", ans:"B"},
  {num:25, q:"Should a meat-focused farm rely solely on inbreeding?", A:"Yes", B:"No, because excessive inbreeding reduces vigor; crossbreeding improves performance", C:"It does not matter", D:"Only color matters", ans:"B"},

  {num:26, q:"Animal nutrition is the study of:", A:"Animal color", B:"How the body uses food for growth and maintenance", C:"Meat grading", D:"Reproduction", ans:"B"},
  {num:27, q:"Carbohydrates mainly provide:", A:"Energy", B:"Minerals", C:"Vitamins", D:"Hormones", ans:"A"},
  {num:28, q:"A pig showing poor growth and rough hair coat likely lacks:", A:"Water", B:"Protein", C:"Fat", D:"Minerals", ans:"B"},
  {num:29, q:"Low calcium and weak bones in young animals most likely indicates:", A:"Mineral excess", B:"Calcium or Vitamin D deficiency", C:"Too much sunlight", D:"Protein deficiency", ans:"B"},
  {num:30, q:"When evaluating nutrient programs, which principle is most important?", A:"Cheapest feed always", B:"Feeds must meet requirements for maintenance, growth, and production", C:"Feeding should not be measured", D:"Only water matters", ans:"B"},

  {num:31, q:"Digestion refers to:", A:"Storing nutrients", B:"Breaking down feed into absorbable forms", C:"Breathing", D:"Reproduction", ans:"B"},
  {num:32, q:"Absorption occurs mainly in the:", A:"Mouth", B:"Stomach", C:"Small intestine", D:"Hooves", ans:"C"},
  {num:33, q:"A ruminant produces gas and bloats after rapid diet changes. This demonstrates:", A:"Good digestion", B:"Fermentation imbalance", C:"No digestive issue", D:"Vitamin excess", ans:"B"},
  {num:34, q:"Rumen fluid analysis shows low microbial activity. Likely conclusion:", A:"Healthy digestion", B:"Poor rumen function due to imbalanced diet", C:"No relation to feeding", D:"Overactive digestion", ans:"B"},
  {num:35, q:"Evaluating digestion and metabolism is essential because:", A:"Only palatability matters", B:"Nutrients must be usable by the animal, not just present", C:"Nutrients do not affect performance", D:"All feeds digest the same", ans:"B"},

  {num:36, q:"Weak legs and rickets in young animals are commonly caused by:", A:"Protein deficiency", B:"Vitamin D or calcium deficiency", C:"Excess fat", D:"Too much light", ans:"B"},
  {num:37, q:"Poor feathering and low egg production in poultry may indicate:", A:"Vitamin deficiency", B:"Water excess", C:"Perfect nutrition", D:"No nutritional issue", ans:"A"},
  {num:38, q:"A pig with poor appetite and anemia likely lacks:", A:"Iron", B:"Protein", C:"Vitamin C", D:"Phosphorus", ans:"A"},
  {num:39, q:"Low magnesium levels causing muscle tremors indicates:", A:"Mineral toxicity", B:"Grass tetany or magnesium deficiency", C:"Improved health", D:"No metabolic issue", ans:"B"},
  {num:40, q:"Correcting vitamin/mineral deficiencies:", A:"Cannot affect productivity", B:"Improves growth, immunity, and performance", C:"Only genetics determines health", D:"Water is the only required nutrient", ans:"B"},

  {num:41, q:"“Dressing percentage” refers to:", A:"Weight of hide", B:"Carcass weight ÷ live weight ×100", C:"Total feed consumed", D:"Bone weight only", ans:"B"},
  {num:42, q:"Poultry usually have a dressing percentage of:", A:"10%", B:"35%", C:"70%–75%", D:"100%", ans:"C"},
  {num:43, q:"If a pig weighs 90 kg live and yields a 65 kg carcass, dressing yield is:", A:"50%", B:"62%", C:"72%", D:"80%", ans:"C"},
  {num:44, q:"Beef generally has higher marbling than poultry. This means:", A:"Beef has more intramuscular fat", B:"Poultry is fattier", C:"Chickens have higher marbling", D:"Marbling does not affect quality", ans:"A"},
  {num:45, q:"A marketing system selling meat directly from producers to consumers is:", A:"Terminal market", B:"Direct market", C:"Auction market", D:"Wholesale market", ans:"B"},

  {num:46, q:"Proximate analysis measures:", A:"Hormones", B:"Moisture, protein, fat, ash, fiber", C:"Vitamins only", D:"Color only", ans:"B"},
  {num:47, q:"Chicken meat generally contains:", A:"Higher fat than pork", B:"Lower fat and higher protein than many red meats", C:"No protein", D:"No nutrients", ans:"B"},
  {num:48, q:"A carcass with excessive bruising results from:", A:"Proper care", B:"Poor pre-slaughter management", C:"High marbling", D:"Genetic defect", ans:"B"},
  {num:49, q:"Consumers avoid meat with poor color and bad odor because:", A:"Appearance and freshness influence acceptance", B:"Quality does not matter", C:"No one cares about safety", D:"All meats look the same", ans:"A"},
  {num:50, q:"Strengthening meat inspection and slaughterhouse standards is:", A:"Unnecessary", B:"Important for safety, quality, and consumer protection", C:"Harmful to farmers", D:"Irrelevant", ans:"B"},
];

/* =============================
   FIREBASE INITIALIZATION
   ============================= */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore, doc, getDoc, setDoc, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { 
  getAuth, signInAnonymously 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyB-idZOq8h9sVttNdzXE2t8FMoYI_snq7g",
  authDomain: "kuya-quiz-100.firebaseapp.com",
  projectId: "kuya-quiz-100",
  storageBucket: "kuya-quiz-100.appspot.com",
  messagingSenderId: "74623975270",
  appId: "1:74623975270:web:dec2b21dbee017292952a7"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const auth = getAuth(app);
try { await signInAnonymously(auth); } catch(e){ console.warn("Anon auth failed:", e); }

/* =============================
   EXAM CONFIG
   ============================= */

const COURSE_TITLE = "Animal Science Final Exam"; // stored in Firestore "Course"
document.title = COURSE_TITLE;

const EXAM_DOC_ID = "ANSCI2025Final";     // finals-exam / ANSCI2025Final / submissions / studentId
const EXAM_SECONDS = 60 * 60;             // 1 hour
// Note: JS months are 0-based: 10 = November
const CLOSING_TIME = new Date(2025, 10, 21, 23, 59, 59);

/* =============================
   DOM ELEMENTS
   ============================= */

const stage0 = document.getElementById("stage0");
const stage1 = document.getElementById("stage1");
const stage2 = document.getElementById("stage2");
const stage3 = document.getElementById("stage3");

const errStage0 = document.getElementById("errStage0");
const errStage1 = document.getElementById("errStage1");
const errStage2 = document.getElementById("errStage2");

const btnUnderstand = document.getElementById("btnUnderstand");
const btnBack = document.getElementById("btnBack");
const btnStart = document.getElementById("btnStart");
const btnPrev = document.getElementById("btnPrev");
const btnNext = document.getElementById("btnNext");
const btnSubmit = document.getElementById("btnSubmit");

const inpName = document.getElementById("inpName");
const inpSection = document.getElementById("inpSection");
const qtext = document.getElementById("qtext");
const choicesEl = document.getElementById("choices");
const barEl = document.getElementById("bar");

const metaRow = document.getElementById("meta");
const pillName = document.getElementById("pillName");
const pillSection = document.getElementById("pillSection");
const pillTimer = document.getElementById("pillTimer");
const pillCount = document.getElementById("pillCount");
const pillAttempts = document.getElementById("pillAttempts");

const rName = document.getElementById("rName");
const rSection = document.getElementById("rSection");
const rScore = document.getElementById("rScore");
const rNote = document.getElementById("rNote");

/* =============================
   STATE
   ============================= */

let currentIndex = 0;
let selectedAnswers = new Array(QUESTIONS.length).fill(null);
let secondsLeft = EXAM_SECONDS;
let timerId = null;

let studentId = null;
let studentName = "";
let studentSection = "";
let attemptCountUsed = 0; // from Firestore
let submitting = false;

/* =============================
   HELPERS
   ============================= */

function isClosed(){
  return new Date() > CLOSING_TIME;
}
function showErr(el,msg){
  el.textContent = msg;
  el.style.display = msg ? "block" : "none";
}
function switchStage(st){
  stage0.classList.add("hidden");
  stage1.classList.add("hidden");
  stage2.classList.add("hidden");
  stage3.classList.add("hidden");
  st.classList.remove("hidden");
}
function makeStudentId(name, section){
  const raw = name.trim().toLowerCase()+"|||"+section.trim().toLowerCase()+"|||"+COURSE_TITLE;
  let base;
  try{ base = btoa(unescape(encodeURIComponent(raw))); }
  catch(e){ base = raw; }
  return base.replace(/[^A-Za-z0-9]/g,"").slice(0,80) || "student";
}

function renderQuestion(){
  const q = QUESTIONS[currentIndex];
  qtext.textContent = q.q;
  choicesEl.innerHTML = "";
  ["A","B","C","D"].forEach(letter=>{
    const checked = selectedAnswers[currentIndex]===letter ? " checked" : "";
    choicesEl.insertAdjacentHTML("beforeend",`
      <label class="choice">
        <input type="radio" name="opt" value="${letter}"${checked}>
        <div><b>${letter}.</b> ${q[letter]}</div>
      </label>
    `);
  });

  pillCount.textContent = `Q: ${currentIndex+1} / ${QUESTIONS.length}`;
  barEl.style.width = (currentIndex/(QUESTIONS.length-1))*100+"%";

  btnPrev.disabled = currentIndex===0;
  if(currentIndex===QUESTIONS.length-1){
    btnNext.classList.add("hidden");
    btnSubmit.classList.remove("hidden");
  } else {
    btnNext.classList.remove("hidden");
    btnSubmit.classList.add("hidden");
  }
  showErr(errStage2,"");
}
function getSelectedValue(){
  const s = choicesEl.querySelector("input[name='opt']:checked");
  return s ? s.value : null;
}
function startTimer(){
  secondsLeft = EXAM_SECONDS;
  if(timerId) clearInterval(timerId);
  timerId = setInterval(()=>{
    secondsLeft--;
    const m = Math.floor(secondsLeft/60), s = secondsLeft%60;
    pillTimer.textContent = `Time: ${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    if(secondsLeft<=0){
      clearInterval(timerId);
      timerId = null;
      autoSubmit();
    }
  },1000);
}
function computeScore(){
  let s=0;
  for(let i=0;i<QUESTIONS.length;i++){
    if(selectedAnswers[i]===QUESTIONS[i].ans) s++;
  }
  return s;
}
function buildAnswerSheet(){
  return QUESTIONS.map((q,i)=>({
    questionNumber:q.num,
    question:q.q,
    options:{A:q.A,B:q.B,C:q.C,D:q.D},
    correctAnswer:q.ans,
    chosenAnswer:selectedAnswers[i],
    isCorrect:selectedAnswers[i]===q.ans
  }));
}

/* =============================
   EVENT HANDLERS
   ============================= */

btnUnderstand.addEventListener("click",()=>{
  if(isClosed()){
    showErr(errStage0,"This exam is already closed.");
    return;
  }
  showErr(errStage0,"");
  switchStage(stage1);
});

btnBack.addEventListener("click",()=>{
  switchStage(stage0);
});

btnStart.addEventListener("click", async ()=>{
  if(isClosed()){
    showErr(errStage1,"This exam is already closed.");
    return;
  }
  const nm = inpName.value.trim();
  const sec = inpSection.value.trim();
  if(!nm){ showErr(errStage1,"Please enter your full name."); return; }
  if(!sec){ showErr(errStage1,"Please enter your Year & Section."); return; }
  showErr(errStage1,"");

  studentName = nm;
  studentSection = sec;
  studentId = makeStudentId(nm, sec);

  // Check attempt count from existing doc (if any)
  try{
    const ref = doc(db,"finals-exam",EXAM_DOC_ID,"submissions",studentId);
    const snap = await getDoc(ref);
    if(snap.exists()){
      const data = snap.data() || {};
      attemptCountUsed = typeof data.attemptCount === "number" ? data.attemptCount : 0;
    } else {
      attemptCountUsed = 0;
    }
  }catch(e){
    console.warn("Attempt check failed:", e);
    // If rules fail, default to 0 so they can still take the exam
    attemptCountUsed = 0;
  }

  if(attemptCountUsed >= 2){
    showErr(errStage1,"You have already used your 2 attempts for this exam.");
    return;
  }

  pillName.textContent = "Name: " + studentName;
  pillSection.textContent = "Year/Section: " + studentSection;
  pillAttempts.textContent = `Attempts used: ${attemptCountUsed} / 2`;
  metaRow.classList.remove("hidden");

  currentIndex = 0;
  selectedAnswers = new Array(QUESTIONS.length).fill(null);

  switchStage(stage2);
  renderQuestion();
  startTimer();
});

btnNext.addEventListener("click",()=>{
  const sel = getSelectedValue();
  if(!sel){
    showErr(errStage2,"Please choose an answer before proceeding.");
    return;
  }
  selectedAnswers[currentIndex] = sel;
  currentIndex++;
  renderQuestion();
});

btnPrev.addEventListener("click",()=>{
  const sel = getSelectedValue();
  if(sel) selectedAnswers[currentIndex] = sel;
  if(currentIndex>0){
    currentIndex--;
    renderQuestion();
  }
});

btnSubmit.addEventListener("click",()=>{
  const sel = getSelectedValue();
  if(!sel){
    showErr(errStage2,"Please choose an answer before submitting.");
    return;
  }
  selectedAnswers[currentIndex] = sel;
  submitExam(false);
});

/* =============================
   SUBMISSION
   ============================= */

async function submitExam(autoSubmitted){
  if(submitting) return;
  submitting = true;

  btnSubmit.disabled = true;
  btnNext.disabled = true;
  btnPrev.disabled = true;

  if(timerId){
    clearInterval(timerId);
    timerId = null;
  }

  // Final attempt check in case doc was updated in between
  let latestAttemptCount = attemptCountUsed;
  try{
    const ref = doc(db,"finals-exam",EXAM_DOC_ID,"submissions",studentId);
    const snap = await getDoc(ref);
    if(snap.exists()){
      const data = snap.data() || {};
      latestAttemptCount = typeof data.attemptCount === "number" ? data.attemptCount : 0;
    } else {
      latestAttemptCount = attemptCountUsed;
    }
  }catch(e){
    console.warn("Re-check attempt failed:", e);
  }

  if(latestAttemptCount >= 2){
    alert("Submission failed: you have already used your 2 attempts.");
    submitting = false;
    btnSubmit.disabled = false;
    btnNext.disabled = false;
    btnPrev.disabled = false;
    return;
  }

  const score = computeScore();
  const answerSheet = buildAnswerSheet();
  const newAttemptCount = latestAttemptCount + 1;

  const payload = {
    Course: COURSE_TITLE,
    submissionDate: serverTimestamp(),
    Score: score,
    Name: studentName,
    section: studentSection,
    secondsRemaining: secondsLeft,
    answers: answerSheet,
    attemptCount: newAttemptCount,
    autoSubmitted: !!autoSubmitted
  };

  try{
    const ref = doc(db,"finals-exam",EXAM_DOC_ID,"submissions",studentId);
    await setDoc(ref, payload, { merge:true });

    alert("Your exam has been submitted.");
    rName.textContent = studentName;
    rSection.textContent = studentSection;
    rScore.textContent = `${score} / ${QUESTIONS.length}`;
    rNote.style.display = "none";
    switchStage(stage3);
  }catch(e){
    console.error("Submission failed:", e);
    alert("Submission failed. Please try again.");
    // allow retry; do NOT disable submit permanently
    submitting = false;
    btnSubmit.disabled = false;
    btnNext.disabled = false;
    btnPrev.disabled = false;
    if(secondsLeft > 0 && !timerId){
      startTimer();
    }
  }
}

async function autoSubmit(){
  const sel = getSelectedValue();
  if(sel) selectedAnswers[currentIndex] = sel;
  await submitExam(true);
}

/* =============================
   INITIAL UI TEXT
   ============================= */
pillTimer.textContent = "Time: 60:00";
pillCount.textContent = "Q: — / " + QUESTIONS.length;
pillAttempts.textContent = "Attempts used: 0 / 2";
</script>
</body>
</html>
